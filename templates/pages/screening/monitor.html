{% extends 'layouts/base.html' %}
{% load static home_filter%}

{% block content %}
<div class="container-fluid">
    <div class="page-header min-height-100 border-radius-xl mt-4"
        style="background-image: url('{% static 'assets/img/curved-images/curved0.jpg' %}'); background-position-y: 50%;">
        <span class="mask bg-gradient-primary opacity-6"></span>
    </div>
    <div class="card card-body blur shadow-blur mx-4 mt-n6 overflow-hidden">
        <div class="row gx-4">
            <div class="col-auto">
                <div class="avatar avatar-xl position-relative">
                    <img src="{% static 'assets/img/bruce-mars.jpg' %}" alt="profile_image"
                        class="w-100 border-radius-lg shadow-sm">
                </div>
            </div>
            <div class="col-auto my-auto">
                <div class="h-100">
                    <h5 class="mb-1">
                        Monitor
                    </h5>
                    <p class="mb-0 font-weight-bold text-sm">
                        Monitor all  wishlist prices
                    </p>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 my-sm-auto ms-sm-auto me-sm-0 mx-auto mt-3">
                <div class="nav-wrapper position-relative end-0">
                    <ul class="nav nav-pills nav-fill p-1 bg-transparent" role="tablist">
                        <li class="nav-item">
                            <a id="monitor_btn" class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="javascript:" role="tab" aria-selected="true">
                                <span class="ms-1">Monitor list</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a id="xxx_btn" class="nav-link mb-0 px-0 py-1 active" data-bs-toggle="tab" href="javascript:" role="tab" aria-selected="false">
                                <span class="ms-1">xxx</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a id="yyy_btn" class="nav-link mb-0 px-0 py-1 active" data-bs-toggle="tab" href="javascript:" role="tab" aria-selected="false">
                                <span class="ms-1">yyy</span>
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="monitor_panel" class="container-fluid py-4">
    <div class="row mt-4">
      <div class="col-sm-8">
        <div class="card h-100">
          <div class="card-header pb-0 p-3">
            <div class="d-flex align-items-center">
              <h6 class="mb-0">Social</h6>
              <button type="button" class="btn btn-icon-only btn-rounded btn-outline-secondary mb-0 ms-2 btn-sm d-flex align-items-center justify-content-center ms-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="See how much traffic do you get from social media">
                <i class="fas fa-info"></i>
              </button>
            </div>
          </div>
          <div class="card-body p-3">
            <ul class="list-group">
              <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                <div class="w-100">
                  <div class="d-flex align-items-center mb-2">
                    <a class="btn btn-facebook btn-simple mb-0 p-0" href="javascript:;">
                      <i class="fab fa-facebook fa-lg"></i>
                    </a>
                    <span class="me-2 text-sm font-weight-bold text-capitalize ms-2">Facebook</span>
                    <span class="ms-auto text-sm font-weight-bold">80%</span>
                  </div>
                  <div>
                    <div class="progress progress-md">
                      <div class="progress-bar bg-gradient-dark w-80" role="progressbar" aria-valuenow="60" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                </div>
              </li>
              <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                <div class="w-100">
                  <div class="d-flex align-items-center mb-2">
                    <a class="btn btn-twitter btn-simple mb-0 p-0" href="javascript:;">
                      <i class="fab fa-twitter fa-lg"></i>
                    </a>
                    <span class="me-2 text-sm font-weight-bold text-capitalize ms-2">Twitter</span>
                    <span class="ms-auto text-sm font-weight-bold">40%</span>
                  </div>
                  <div>
                    <div class="progress progress-md">
                      <div class="progress-bar bg-gradient-dark w-40" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                </div>
              </li>
              <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                <div class="w-100">
                  <div class="d-flex align-items-center mb-2">
                    <a class="btn btn-reddit btn-simple mb-0 p-0" href="javascript:;">
                      <i class="fab fa-reddit fa-lg"></i>
                    </a>
                    <span class="me-2 text-sm font-weight-bold text-capitalize ms-2">Reddit</span>
                    <span class="ms-auto text-sm font-weight-bold">30%</span>
                  </div>
                  <div>
                    <div class="progress progress-md">
                      <div class="progress-bar bg-gradient-dark w-30" role="progressbar" aria-valuenow="30" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                </div>
              </li>
              <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                <div class="w-100">
                  <div class="d-flex align-items-center mb-2">
                    <a class="btn btn-youtube btn-simple mb-0 p-0" href="javascript:;">
                      <i class="fab fa-youtube fa-lg"></i>
                    </a>
                    <span class="me-2 text-sm font-weight-bold text-capitalize ms-2">Youtube</span>
                    <span class="ms-auto text-sm font-weight-bold">25%</span>
                  </div>
                  <div>
                    <div class="progress progress-md">
                      <div class="progress-bar bg-gradient-dark w-25" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                </div>
              </li>
              <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                <div class="w-100">
                  <div class="d-flex align-items-center mb-2">
                    <a class="btn btn-slack btn-simple mb-0 p-0" href="javascript:;">
                      <i class="fab fa-slack fa-lg"></i>
                    </a>
                    <span class="me-2 text-sm font-weight-bold text-capitalize ms-2">Slack</span>
                    <span class="ms-auto text-sm font-weight-bold">15%</span>
                  </div>
                  <div>
                    <div class="progress progress-md">
                      <div class="progress-bar bg-gradient-dark w-15" role="progressbar" aria-valuenow="15" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                  </div>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="col-sm-4">
        <div class="card h-100 mt-4 mt-md-0">
          <div class="card-header pb-0 p-3">
            <div class="d-flex align-items-center">
              <h6>Monitor list</h6>
              <button type="button" class="btn btn-icon-only btn-rounded btn-outline-success mb-0 ms-2 btn-sm d-flex align-items-center justify-content-center ms-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Data is based from sessions and is 100% accurate">
                <i class="fas fa-check"></i>
              </button>
            </div>
          </div>
          <div class="card-body px-3 pt-0 pb-2">
            <div class="table-responsive p-0">
              <table class="table align-items-center justify-content-center mb-0">
                <thead>
                  <tr>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Symbol</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Last</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Chg</th>
                    <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Chg%</th>
                  </tr>
                </thead>
                <tbody>
                {% for item in watchlist %}
                  <tr id="monitor_row">
                    <td>
                      <p class="text-sm font-weight-bold mb-0" id="{{ item.symbol_id }}_symbol">{{ item.symbol_id}}</p>
                    </td>
                    <td>
                      <p class="text-sm font-weight-bold mb-0" id="{{ item.symbol_id }}_last"></p>
                    </td>
                    <td>
                      <p class="text-sm font-weight-bold mb-0" id="{{ item.symbol_id }}_chg"></p>
                    </td>
                    <td>
                      <p class="text-sm font-weight-bold mb-0" id="{{ item.symbol_id }}_chg_pct"></p>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row mt-3">
        <div class="col-12 col-lg-12">
            <div class="card mb-4">
                <div class="card-header pb-0 p-3 d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="mb-1">Socket Console</h6>
                    </div>
                    <ul class="nav nav-tabs" id="consoleTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <a class="nav-link active" id="quote-tab" data-bs-toggle="tab" href="#quote-console" role="tab" aria-controls="quote-console" aria-selected="true">Quote Console</a>
                    </li>
                    <li class="nav-item" role="presentation">
                        <a class="nav-link" id="hist-tab" data-bs-toggle="tab" href="#hist-console" role="tab" aria-controls="hist-console" aria-selected="false">Historical Console</a>
                    </li>
                </ul>
                </div>
                <div class="card-body p-3">
                <div class="tab-content" id="consoleTabsContent">
                    <div class="tab-pane fade show active" id="quote-console" role="tabpanel" aria-labelledby="quote-tab">
                        <div id="quote-console-content" style="height: 100px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background-color: #f9f9f9; font-size: 12px;"></div>
                    </div>
                    <div class="tab-pane fade" id="hist-console" role="tabpanel" aria-labelledby="hist-tab">
                        <div id="hist-console-content" style="height: 100px; overflow-y: scroll; border: 1px solid #ccc; padding: 10px; background-color: #f9f9f9; font-size: 12px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<div id="xxx_panel" class="container-fluid py-4">
</div>
<div id="yyy_panel" class="container-fluid py-4">
</div>


{% endblock content %}

<!-- Specific JS goes HERE -->
{% block extra_js %}
<script>
    let quote_dic = {};

    function socket_onmessage(event) {
        const data = JSON.parse(event.data);
        let symbol = data.key;

        if (data.type === 'quote'){
            stock_obj = cache_stock_obj(true, symbol, data.detail);
            render_stock_obj(true, symbol, stock_obj);
            handle_quote(symbol, stock_obj);
        }
        if (data.type === 'hist' && data.interval === 'D'){
            stock_obj = cache_stock_obj(false, symbol, data.detail);
            render_stock_obj(false, symbol, stock_obj);
            handle_hist(symbol, stock_obj);
        }
    }

    function cache_stock_obj(is_quote, key, detail){
        let old_obj;
        let current_obj;

        if (quote_dic.hasOwnProperty(key)){
            old_obj = { ...quote_dic[key] };
            if (is_quote)
                quote_dic[key]['quote'] = detail;
            else
                quote_dic[key]['hist'] = detail;
        }
        else{
            if (is_quote)
                quote_dic[key] = {'quote': detail, 'hist': null};
            else
                quote_dic[key] = {'quote': null, 'hist': detail};
            old_obj = { ...quote_dic[key] };
        }
        current_obj = quote_dic[key];
        return {old: old_obj, current: current_obj};
    }

    function get_stock_price(detail_json){
        let detail = detail_json.quote;
        if (!detail)
            detail = detail_json.hist;
        let price = detail.close;
        if (detail_json.quote) {
            price = detail.last !== null ? detail.last : detail.close;
        }
        return price;
    }


    function render_stock_obj(is_quote, key, stock_obj){

        // 1. Stock Current Price
        old_price = get_stock_price(stock_obj.old);
        price = get_stock_price(stock_obj.current);

        // Update the UI with the stock price changes
        const lastEle = document.getElementById(`${key}_last`);
        if (lastEle) {
            lastEle.textContent = price;
            if (price > old_price) {
                lastEle.style.color = 'green';
            } else if (price < old_price) {
                lastEle.style.color = 'red';
            } else {
                lastEle.style.color = '';
            }
        }

        // Calculate change and change percentage
        pre_close_price = stock_obj.current.hist.pre_close;
        const chg = price - pre_close_price;
        const chgPct = (chg / pre_close_price) * 100;

        const chgEle = document.getElementById(`${key}_chg`);
        const chgPctEle = document.getElementById(`${key}_chg_pct`);
        // Update the change and change percentage elements
        if (chgEle) {
            chgEle.textContent = chg.toFixed(2);
            style = price > pre_close_price ? 'green' : price < pre_close_price ? 'red' : '';
            chgEle.style.color = style;
        }
        if (chgPctEle) {
            chgPctEle.textContent = chgPct.toFixed(2) + '%';
            style = price > pre_close_price ? 'green' : price < pre_close_price ? 'red' : '';
            chgPctEle.style.color = style;
        }
    }

    function handle_quote(key, stock_obj){
        detail = stock_obj.current.quote
        // Format the message
        const date = new Date(detail.time);
        const formattedDate = date.toISOString().replace('T', ' ').split('.')[0];
        const output = `${formattedDate} ${key} :
            Last:${detail.last !== null ? detail.last : ''},
            Close:${detail.close !== null ? detail.close : ''},
            Bid:${detail.bid !== null ? detail.bid : ''},
            Ask:${detail.ask !== null ? detail.ask : ''},
            High:${detail.high !== null ? detail.high : ''},
            Low:${detail.low !== null ? detail.low : ''},
            Volume:${detail.volume !== null ? detail.volume : ''}`;

        // Append the original message to the console
        console_log('quote-console-content', output)
    }

    function handle_hist(key, stock_obj){
        detail = stock_obj.current.hist
        // Format the message
        const output = `${key}:
            ${detail.date} close @ ${detail.close},
            ${detail.pre_time} close @ ${detail.pre_close}`;

        // Append the original message to the historical console
        console_log('hist-console-content', output)
    }

    function console_log(console_id, message){
        // Append the original message to the console
        const consoleElement = document.getElementById(console_id);
        const messageElement = document.createElement('div');
        messageElement.textContent = message;
        consoleElement.appendChild(messageElement);
        consoleElement.scrollTop = consoleElement.scrollHeight; // Auto-scroll to the bottom

        // Limit the total rows to 100
        while (consoleElement.children.length > 100) {
            consoleElement.removeChild(consoleElement.firstChild);
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        const socket = new WebSocket('ws://' + window.location.host + '/ws/stock_quote/');

        socket.onmessage = socket_onmessage

        socket.onclose = function(event) {
            console.error('WebSocket closed unexpectedly');
        };
    });

</script>
{% endblock extra_js %}