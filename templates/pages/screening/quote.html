{% extends 'layouts/base.html' %}
{% load static home_filter%}

{% block content %}
    <div class="container-fluid">
        <div class="page-header min-height-300 border-radius-xl mt-4" style="background-image: url('{% static 'assets/img/curved-images/curved0.jpg' %}'); background-position-y: 50%;">
          <span class="mask bg-gradient-primary opacity-6"></span>
        </div>
        <div class="card card-body blur shadow-blur mx-4 mt-n6 overflow-hidden">
          <div class="row gx-4">
            <div class="col-auto">
              <div class="avatar avatar-xl position-relative">
                <img src="{% static 'assets/img/bruce-mars.jpg' %}" alt="profile_image" class="w-100 border-radius-lg shadow-sm">
              </div>
            </div>
            <div class="col-auto my-auto">
              <div class="h-100">
                <h5 class="mb-1">
                    {{ symbol }}
                </h5>
                <p class="mb-0 font-weight-bold text-sm">
                    {{ stock|get_stock_field:"symbol:market" }} :  {{ stock|get_stock_field:"symbol:name" }}
                </p>
              </div>
            </div>
            <div class="col-lg-8 col-md-6 my-sm-auto ms-sm-auto me-sm-0 mx-auto mt-3">
              <div class="nav-wrapper position-relative end-0">
                <ul class="nav nav-pills nav-fill p-1 bg-transparent" role="tablist">
                    <li class="nav-item" role="tab" >
                    <a id="holding_btn" class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="javascript:" aria-selected="true">
                      <span class="ms-1">Holding</span>
                    </a>
                  </li>
                  <li class="nav-item" role="tab" >
                    <a id="chart_btn" class="nav-link mb-0 px-0 py-1 active" data-bs-toggle="tab" href="javascript:" aria-selected="true" >
                      <span class="ms-1">Chart</span>
                    </a>
                  </li>
                  <li class="nav-item" role="tab">
                    <a id="profile_btn" class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="javascript:" aria-selected="true" >
                      <span class="ms-1">Profile</span>
                    </a>
                  </li>
                  <li class="nav-item" role="tab" >
                    <a id="technical_btn" class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="javascript:" aria-selected="true">
                      <span class="ms-1">Technical</span>
                    </a>
                  </li>
                  <li class="nav-item" role="tab" >
                    <a id="fundamental_btn" class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="javascript:" aria-selected="true">
                      <span class="ms-1">Fundamental</span>
                    </a>
                  </li>
                  <li class="nav-item" role="tab" >
                    <a id="ratings_btn" class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="javascript:" aria-selected="true">
                      <span class="ms-1">Ratings</span>
                    </a>
                  </li>
                  <li class="nav-item" role="tab" >
                    <a id="estimates_btn" class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="javascript:" aria-selected="true">
                      <span class="ms-1">Estimates</span>
                    </a>
                  </li>
                  <li class="nav-item" role="tab" >
                    <a id="financials_btn" class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="javascript:" aria-selected="true">
                      <span class="ms-1">Financials</span>
                    </a>
                  </li>
                  <li class="nav-item" role="tab" >
                    <a id="ownership_btn" class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="javascript:" aria-selected="true">
                      <span class="ms-1">Ownership</span>
                    </a>
                  </li>
                  <li class="nav-item" role="tab" >
                    <a id="news_btn" class="nav-link mb-0 px-0 py-1" data-bs-toggle="tab" href="javascript:" aria-selected="true">
                      <span class="ms-1">News</span>
                    </a>
                  </li>
    
                </ul>
              </div>
            </div>
          </div>
        </div>
    </div>
    <div id="holding_panel" class="container-fluid py-4">
        <div class="row mt-3">
            <div class="col-12 col-lg-7">
                <div class="card mb-4">
                    <div class="card-header pb-0 p-3 d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Buy Order</h6>
                            <p class="text-sm">Market/Limit</p>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm"
                                onclick="CreateOrderModal('buy',1)">Create Buy Order
                        </button>
                    </div>
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="table-responsive">
                                <table class="table table-flush table-hover" id="buy_order_table">
                                    <thead class="thead-light">
                                    <tr>
                                        <th>T.O.ID</th>

                                        <th>Quantity</th>
                                        <th>Detail</th>
                                        <th>Place Date</th>

                                        <th>Status</th>
                                        <th>Purpose</th>
                                        <th>Action</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for buy_order in buy_orders %}
                                        <tr>
                                            <td>
                                                <a href="javascript:void(0);"
                                                   onclick="calculateTrade({{ buy_order.trade_id }})">
                                                    <span class="form-label fw-bold fs-6 {% if buy_order.is_finished %}text-success{% else %}text-black{% endif %}">{{ buy_order.trade_id }}</span>
                                                </a>-{{ buy_order.order_id }}
                                            </td>

                                            <td><strong>{{ buy_order.quantity_target }}
                                                / {{ buy_order.filled_quantity }}</strong></td>
                                            <td><strong>{{ segment|order_price:buy_order }}</strong></td>

                                            <td class="text-dark">{{ buy_order.order_place_date|date:"m-d-Y" }}</td>
                                            <td>
                                                {% if buy_order.filled_rate == 0 %}
                                                    <span class="text-primary fw-bold">Open</span>
                                                {% elif buy_order.filled_rate == 100 %}
                                                    <span class="text-success fw-bold">Filled</span>
                                                {% else %}
                                                    <span class="text-secondary fw-bold">
                                                    Fill <strong>{{ buy_order.filled_rate|floatformat:2 }}%</strong>
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td>{{ segment|action_lookup:buy_order.action }}</td>
                                            <td>
                                                {% if not buy_order.is_filled %}
                                                    <a href="javascript:showBuyOrderFill('{{ buy_order.order_id }}','{{ buy_order.trade_id }}', '{{ buy_order.price_market }}', '{{ buy_order.order_place_date|date:"Y-m-d" }}', '{{ buy_order.quantity_target }}')"
                                                       data-bs-toggle="tooltip" data-bs-original-title="Fill">
                                                        <i class="fas fa-pen text-primary"></i>
                                                    </a>
                                                {% endif %}
                                                <a href="javascript:loadEditOrder('{{ buy_order.order_id }}')"
                                                   class="mx-3" data-bs-toggle="tooltip" data-bs-original-title="Edit">
                                                    <i class="fas fa-user-edit text-info"></i>
                                                </a>
                                                <a href="javascript:deleteOrder('{{ buy_order.order_id }}')"
                                                   data-bs-toggle="tooltip" data-bs-original-title="Delete">
                                                    <i class="fas fa-trash text-secondary"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card mb-4">
                    <div class="card-header pb-0 p-3 d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">Sell Order</h6>
                            <p class="text-sm">Stop/Limit</p>
                        </div>
                        <button type="button" class="btn btn-outline-primary btn-sm"
                                onclick="CreateOrderModal('sell', 4)">Create Sell Order
                        </button>
                    </div>
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="table-responsive">
                                <table class="table table-flush table-hover" id="sell_order_table">
                                    <thead class="thead-light">
                                    <tr>
                                        <th>T.O.ID</th>

                                        <th>Quantity</th>
                                        <th>Detail</th>

                                        <th>Place Date</th>
                                        <th>Status</th>
                                        <th>Purpose</th>
                                        <th>Action</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for sell_order in sell_orders %}
                                        <tr>
                                            <td>
                                                <a href="javascript:void(0);"
                                                   onclick="calculateTrade({{ sell_order.trade_id }})">
                                                    <span class="form-label fw-bold fs-6 {% if sell_order.is_finished %}text-success{% else %}text-black{% endif %}">{{ sell_order.trade_id }}</span>
                                                </a>-{{ sell_order.order_id }}
                                            </td>

                                            <td><strong>{{ sell_order.quantity_target }}
                                                / {{ sell_order.filled_quantity }}</strong></td>
                                            <td><strong>{{ segment|order_price:sell_order }}</strong></td>

                                            <td class="text-dark">{{ sell_order.order_place_date|date:"m-d-Y" }}</td>
                                            <td>
                                                {% if sell_order.is_obsolete %}
                                                    <span class="text-secondary">Obsolete</span>
                                                {% else %}
                                                    {% if sell_order.filled_rate is None or sell_order.filled_rate == 0 %}
                                                        <span class="text-primary fw-bold">Open</span>
                                                    {% elif sell_order.filled_rate == 100 %}
                                                        <span class="text-success fw-bold">Filled</span>
                                                    {% else %}
                                                        Fill
                                                        <strong>{{ sell_order.filled_rate|floatformat:2 }}%</strong>
                                                    {% endif %}
                                                {% endif %}
                                            </td>
                                            <td>{{ segment|action_lookup:sell_order.action }}</td>
                                            <td>
                                                {% if not sell_order.is_filled and not sell_order.is_obsolete %}
                                                    <a href="javascript:showSellOrderFill('{{ sell_order.order_id }}','{{ sell_order.trade_id }}', '{{ sell_order.price_limit }}', '{{ sell_order.order_place_date|date:"Y-m-d" }}', '{{ sell_order.quantity_target }}')"
                                                       data-bs-toggle="tooltip" data-bs-original-title="Fill">
                                                        <i class="fas fa-pen text-primary"></i>
                                                    </a>
                                                    <a href="javascript:popAdjustSellOrder('{{ sell_order.order_id }}', '{{ sell_order.quantity_target }}','{{ sell_order.price_stop }}', '{{ sell_order.price_limit }}')"
                                                       data-bs-toggle="tooltip" data-bs-original-title="Adjust">
                                                        <i class="fas fa-sliders text-primary"></i>
                                                    </a>
                                                {% endif %}
                                                <a href="javascript:loadEditOrder('{{ sell_order.order_id }}')"
                                                   class="mx-3" data-bs-toggle="tooltip" data-bs-original-title="Edit">
                                                    <i class="fas fa-user-edit text-info"></i>
                                                </a>
                                                <a href="javascript:deleteOrder('{{ sell_order.order_id }}')"
                                                   data-bs-toggle="tooltip" data-bs-original-title="Delete">
                                                    <i class="fas fa-trash text-secondary"></i>
                                                </a>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-12 col-lg-5">
                <div class="card mb-4">
                    <div class="card-header pb-0 p-3">
                        <h6 class="mb-1">Transaction</h6>
                    </div>
                    <div class="card-body p-3">
                        <div class="row">
                            <div class="table-responsive">
                                <table class="table table-flush table-hover" id="buy_action_table">
                                    <thead class="thead-light">
                                    <tr>
                                        <th>T.O.T.ID</th>
                                        <th>Action</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Fees</th>
                                        <th>Date</th>
                                        <th>Action</th>
                                    </tr>
                                    </thead>
                                    <tbody>
                                    {% for transaction in transactions %}
                                        <tr>
                                            <td>
                                                <a href="javascript:void(0);"
                                                   onclick="calculateTrade({{ transaction.trade_id }})">
                                                    <span class="form-label fw-bold fs-6 {% if transaction.is_finished %}text-success{% else %}text-black{% endif %}">{{ transaction.trade_id }}</span>
                                                </a>-{{ transaction.order_id }}-{{ transaction.transaction_id }}</td>
                                            <td>
                                                <strong>{{ segment|transaction_type_lookup:transaction.transaction_type }}</strong>
                                            </td>
                                            <td><strong>{{ transaction.quantity_final }}</strong></td>
                                            <td><strong>{{ transaction.price_final }}</strong></td>
                                            <td>{{ transaction.commission|default_if_none:"" }}</td>
                                            <td>{{ transaction.date|date:"m-d-Y" }}</td>
                                            <td>
                                                <a href="javascript:editTransaction('{{ transaction.transaction_id }}')"
                                                   class="mx-3" data-bs-toggle="tooltip" data-bs-original-title="Edit">
                                                    <i class="fas fa-user-edit text-info"></i>
                                                </a>
                                                <a href="javascript:deleteTransaction('{{ transaction.transaction_id }}')"
                                                   data-bs-toggle="tooltip" data-bs-original-title="Delete">
                                                    <i class="fas fa-trash text-secondary"></i>
                                                </a>
                                            </td>

                                        </tr>
                                    {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="profile_panel" class="container-fluid py-4">
        <div class="row mt-3">
            <div class="col-12 col-md-6 col-xl-4">
        <div class="card h-100">
          <div class="card-header pb-0 p-3">
            <h6 class="mb-0">Fundamental</h6>
          </div>
          <div class="card-body p-3">
              <h6 class="text text-dark text-sm font-weight-bolder mt-4">Sector</h6>
              <div class="table-responsive">
                  <table class="table align-items-center mb-0">
                      <tbody>
                      <tr>
                          <td>
                          <div class="d-flex px-2 py-0">
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0 text-xs text-body">GICS Sector</h6>
                            </div>
                          </div>
                        </td>
                        <td class="align-middle text-end text-xs">
                          <span class="text-xs font-weight-bold text-info"> {{ stock|get_stock_field:"stock:sector"}} </span>
                        </td>
                      </tr>
                      <tr>
                        <td>
                          <div class="d-flex px-2 py-0">
                            <div class="d-flex flex-column justify-content-center">
                              <h6 class="mb-0 text-xs text-body">GICS Industry</h6>
                            </div>
                          </div>
                        </td>
                        <td class="align-middle text-end text-xs">
                          <span class="text-xs font-weight-bold text-info"> {{ stock|get_stock_field:"stock:industry"}} </span>
                        </td>
                      </tr>
                      </tbody>
                  </table>
              </div>
              <hr>
              <h6 class="text text-dark text-xs font-weight-bolder">Overview</h6>
              <div class="table-responsive">
                  <table class="table align-items-center mb-0">
                      <tbody>
                      <tr>
                          <td>
                              <div class="d-flex px-2 py-0">
                                  <div class="d-flex flex-column justify-content-center">
                                      <h6 class="mb-0 text-xs text-body">Earnings (Last)</h6>
                                  </div>
                              </div>
                          </td>
                          <td class="align-middle text-end text-xs">
                              <span class="text-xs font-weight-bold text-info"> </span>
                          </td>
                          <td>
                              <div class="d-flex px-2 py-0">
                                  <div class="d-flex flex-column justify-content-center">
                                      <h6 class="mb-0 text-xs text-body">Earnings (Next)</h6>
                                  </div>
                              </div>
                          </td>
                          <td class="align-middle text-end text-xs">
                              <span class="text-xs font-weight-bold text-info"></span>
                          </td>
                      </tr>
                      <tr>
                          <td>
                              <div class="d-flex px-2 py-0">
                                  <div class="d-flex flex-column justify-content-center">
                                      <h6 class="mb-0 text-xs text-body">Inst Owners</h6>
                                  </div>
                              </div>
                          </td>
                          <td class="align-middle text-end text-xs">
                              <span class="text-xs font-weight-bold text-info"> </span>
                          </td>
                          <td>
                              <div class="d-flex px-2 py-0">
                                  <div class="d-flex flex-column justify-content-center">
                                      <h6 class="mb-0 text-xs text-body">GICS Sector</h6>
                                  </div>
                              </div>
                          </td>
                          <td class="align-middle text-end text-xs">
                              <span class="text-xs font-weight-bold text-info"> </span>
                          </td>
                      </tr>
                      </tbody>
                  </table>
              </div>
              <h6 class="text-uppercase text-body text-xs font-weight-bolder mt-4">Application</h6>
              <ul class="list-group">
                  <li class="list-group-item border-0 px-0">
                    <div class="form-check form-switch ps-0">
                      <input class="form-check-input ms-auto" type="checkbox" id="flexSwitchCheckDefault3">
                      <label class="form-check-label text-body ms-3 text-truncate w-80 mb-0" for="flexSwitchCheckDefault3">New launches and projects</label>
                    </div>
                  </li>
                  <li class="list-group-item border-0 px-0">
                    <div class="form-check form-switch ps-0">
                      <input class="form-check-input ms-auto" type="checkbox" id="flexSwitchCheckDefault4" checked>
                      <label class="form-check-label text-body ms-3 text-truncate w-80 mb-0" for="flexSwitchCheckDefault4">Monthly product updates</label>
                    </div>
                  </li>
                  <li class="list-group-item border-0 px-0 pb-0">
                    <div class="form-check form-switch ps-0">
                      <input class="form-check-input ms-auto" type="checkbox" id="flexSwitchCheckDefault5">
                      <label class="form-check-label text-body ms-3 text-truncate w-80 mb-0" for="flexSwitchCheckDefault5">Subscribe to newsletter</label>
                    </div>
                  </li>
              </ul>
          </div>
        </div>
      </div>
            <div class="col-12 col-md-6 col-xl-4 mt-md-0 mt-4">
        <div class="card h-100">
          <div class="card-header pb-0 p-3">
            <div class="row">
              <div class="col-md-8 d-flex align-items-center">
                <h6 class="mb-0">Company Profile</h6>
              </div>
              <div class="col-md-4 text-end">
                <a href="javascript:">
                  <i class="fas fa-user-edit text-secondary text-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Edit Profile"></i>
                </a>
              </div>
            </div>
          </div>
          <div class="card-body p-3">
            <p class="text-sm">
                {{ stock|get_stock_field:"stock:long_business_summary" }}
            </p>
            <hr class="horizontal gray-light my-4">
            <ul class="list-group">
              <li class="list-group-item border-0 ps-0 pt-0 text-sm"><strong class="text-dark">Full Name:</strong> &nbsp; Alec M. Thompson</li>
              <li class="list-group-item border-0 ps-0 text-sm"><strong class="text-dark">Mobile:</strong> &nbsp; (44) 123 1234 123</li>
              <li class="list-group-item border-0 ps-0 text-sm"><strong class="text-dark">Email:</strong> &nbsp; alecthompson@mail.com</li>
              <li class="list-group-item border-0 ps-0 text-sm"><strong class="text-dark">Location:</strong> &nbsp; USA</li>
              <li class="list-group-item border-0 ps-0 pb-0">
                <strong class="text-dark text-sm">Social:</strong> &nbsp;
                <a class="btn btn-facebook btn-simple mb-0 ps-1 pe-2 py-0" href="javascript:">
                  <i class="fab fa-facebook fa-lg"></i>
                </a>
                <a class="btn btn-twitter btn-simple mb-0 ps-1 pe-2 py-0" href="javascript:">
                  <i class="fab fa-twitter fa-lg"></i>
                </a>
                <a class="btn btn-instagram btn-simple mb-0 ps-1 pe-2 py-0" href="javascript:">
                  <i class="fab fa-instagram fa-lg"></i>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
            <div class="col-12 col-xl-4 mt-xl-0 mt-4">
        <div class="card h-100">
          <div class="card-header pb-0 p-3">
            <h6 class="mb-0">Conversations</h6>
          </div>
          <div class="card-body p-3">
            <ul class="list-group">
              <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                <div class="avatar me-3">
                  <img src="{% static 'assets/img/kal-visuals-square.jpg' %}" alt="kal" class="border-radius-lg shadow">
                </div>
                <div class="d-flex align-items-start flex-column justify-content-center">
                  <h6 class="mb-0 text-sm">Sophie B.</h6>
                  <p class="mb-0 text-xs">Hi! I need more information..</p>
                </div>
                <a class="btn btn-link pe-3 ps-0 mb-0 ms-auto" href="javascript:">Reply</a>
              </li>
              <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                <div class="avatar me-3">
                  <img src="{% static 'assets/img/marie.jpg' %}" alt="kal" class="border-radius-lg shadow">
                </div>
                <div class="d-flex align-items-start flex-column justify-content-center">
                  <h6 class="mb-0 text-sm">Anne Marie</h6>
                  <p class="mb-0 text-xs">Awesome work, can you..</p>
                </div>
                <a class="btn btn-link pe-3 ps-0 mb-0 ms-auto" href="javascript:">Reply</a>
              </li>
              <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                <div class="avatar me-3">
                  <img src="{% static 'assets/img/ivana-square.jpg' %}" alt="kal" class="border-radius-lg shadow">
                </div>
                <div class="d-flex align-items-start flex-column justify-content-center">
                  <h6 class="mb-0 text-sm">Ivanna</h6>
                  <p class="mb-0 text-xs">About files I can..</p>
                </div>
                <a class="btn btn-link pe-3 ps-0 mb-0 ms-auto" href="javascript:">Reply</a>
              </li>
              <li class="list-group-item border-0 d-flex align-items-center px-0 mb-2">
                <div class="avatar me-3">
                  <img src="{% static 'assets/img/team-4.jpg' %}" alt="kal" class="border-radius-lg shadow">
                </div>
                <div class="d-flex align-items-start flex-column justify-content-center">
                  <h6 class="mb-0 text-sm">Peterson</h6>
                  <p class="mb-0 text-xs">Have a great afternoon..</p>
                </div>
                <a class="btn btn-link pe-3 ps-0 mb-0 ms-auto" href="javascript:">Reply</a>
              </li>
              <li class="list-group-item border-0 d-flex align-items-center px-0">
                <div class="avatar me-3">
                  <img src="{% static 'assets/img/team-3.jpg' %}" alt="kal" class="border-radius-lg shadow">
                </div>
                <div class="d-flex align-items-start flex-column justify-content-center">
                  <h6 class="mb-0 text-sm">Nick Daniel</h6>
                  <p class="mb-0 text-xs">Hi! I need more information..</p>
                </div>
                <a class="btn btn-link pe-3 ps-0 mb-0 ms-auto" href="javascript:">Reply</a>
              </li>
            </ul>
          </div>
        </div>
      </div>
        </div>
        <div class="row mt-4">
      <div class="col-12">
        <div class="card mb-4">
          <div class="card-header pb-0 p-3">
            <h6 class="mb-1">Projects</h6>
            <p class="text-sm">Architects design houses</p>
          </div>
          <div class="card-body p-3">
            <div class="row">
              <div class="col-xl-3 col-md-6 mb-xl-0 mb-4">
                <div class="card card-blog card-plain">
                  <div class="position-relative">
                    <a class="d-block shadow-xl border-radius-xl">
                      <img src="{% static 'assets/img/home-decor-1.jpg' %}" alt="img-blur-shadow" class="img-fluid shadow border-radius-xl">
                    </a>
                  </div>
                  <div class="card-body px-1 pb-0">
                    <p class="text-gradient text-dark mb-2 text-sm">Project #2</p>
                    <a href="javascript:">
                      <h5>
                        Modern
                      </h5>
                    </a>
                    <p class="mb-4 text-sm">
                      As Uber works through a huge amount of internal management turmoil.
                    </p>
                    <div class="d-flex align-items-center justify-content-between">
                      <button type="button" class="btn btn-outline-primary btn-sm mb-0">View Project</button>
                      <div class="avatar-group mt-2">
                        <a href="javascript:" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Elena Morison">
                          <img alt="Image placeholder" src="{% static 'assets/img/team-1.jpg' %}">
                        </a>
                        <a href="javascript:" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Ryan Milly">
                          <img alt="Image placeholder" src="{% static 'assets/img/team-2.jpg' %}">
                        </a>
                        <a href="javascript:" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Nick Daniel">
                          <img alt="Image placeholder" src="{% static 'assets/img/team-3.jpg' %}">
                        </a>
                        <a href="javascript:" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Peterson">
                          <img alt="Image placeholder" src="{% static 'assets/img/team-4.jpg' %}">
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xl-3 col-md-6 mb-xl-0 mb-4">
                <div class="card card-blog card-plain">
                  <div class="position-relative">
                    <a class="d-block shadow-xl border-radius-xl">
                      <img src="{% static 'assets/img/home-decor-2.jpg' %}" alt="img-blur-shadow" class="img-fluid shadow border-radius-lg">
                    </a>
                  </div>
                  <div class="card-body px-1 pb-0">
                    <p class="text-gradient text-dark mb-2 text-sm">Project #1</p>
                    <a href="javascript:">
                      <h5>
                        Scandinavian
                      </h5>
                    </a>
                    <p class="mb-4 text-sm">
                      Music is something that every person has his or her own specific opinion about.
                    </p>
                    <div class="d-flex align-items-center justify-content-between">
                      <button type="button" class="btn btn-outline-primary btn-sm mb-0">View Project</button>
                      <div class="avatar-group mt-2">
                        <a href="javascript:" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Nick Daniel">
                          <img alt="Image placeholder" src="{% static 'assets/img/team-3.jpg' %}">
                        </a>
                        <a href="javascript:" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Peterson">
                          <img alt="Image placeholder" src="{% static 'assets/img/team-4.jpg' %}">
                        </a>
                        <a href="javascript:" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Elena Morison">
                          <img alt="Image placeholder" src="{% static 'assets/img/team-1.jpg' %}">
                        </a>
                        <a href="javascript:" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Ryan Milly">
                          <img alt="Image placeholder" src="{% static 'assets/img/team-2.jpg' %}">
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xl-3 col-md-6 mb-xl-0 mb-4">
                <div class="card card-blog card-plain">
                  <div class="position-relative">
                    <a class="d-block shadow-xl border-radius-xl">
                      <img src="{% static 'assets/img/home-decor-3.jpg' %}" alt="img-blur-shadow" class="img-fluid shadow border-radius-xl">
                    </a>
                  </div>
                  <div class="card-body px-1 pb-0">
                    <p class="text-gradient text-dark mb-2 text-sm">Project #3</p>
                    <a href="javascript:">
                      <h5>
                        Minimalist
                      </h5>
                    </a>
                    <p class="mb-4 text-sm">
                      Different people have different taste, and various types of music.
                    </p>
                    <div class="d-flex align-items-center justify-content-between">
                      <button type="button" class="btn btn-outline-primary btn-sm mb-0">View Project</button>
                      <div class="avatar-group mt-2">
                        <a href="javascript:" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Peterson">
                          <img alt="Image placeholder" src="{% static 'assets/img/team-4.jpg' %}">
                        </a>
                        <a href="javascript:" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Nick Daniel">
                          <img alt="Image placeholder" src="{% static 'assets/img/team-3.jpg' %}">
                        </a>
                        <a href="javascript:" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Ryan Milly">
                          <img alt="Image placeholder" src="{% static 'assets/img/team-2.jpg' %}">
                        </a>
                        <a href="javascript:" class="avatar avatar-xs rounded-circle" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Elena Morison">
                          <img alt="Image placeholder" src="{% static 'assets/img/team-1.jpg' %}">
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="col-xl-3 col-md-6 mb-xl-0 mb-4">
                <div class="card h-100 card-plain border">
                  <div class="card-body d-flex flex-column justify-content-center text-center">
                    <a href="javascript:">
                      <i class="fa fa-plus text-secondary mb-3"></i>
                      <h5 class=" text-secondary"> New project </h5>
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    </div>
    <div id="chart_panel" class="container-fluid py-3" style="display: none;">
        <!-- Chart panel content -->
        <div class="container">
          <div class="row">
            <div class="col-sm">
              <span></span>
            </div>
            <div class="col-sm">
              <span></span>
            </div>
            <div class="col-sm">
              <div class="col-sm chart-controls">
                  <button type="button" class="btn btn-outline-secondary" onclick="updateChartInterval('daily')">Daily</button>
                  <button type="button" class="btn btn-outline-secondary" onclick="updateChartInterval('weekly')">Weekly</button>
                  <button type="button" class="btn btn-outline-secondary" onclick="updateChartInterval('monthly')">Monthly</button>
              </div>
            </div>
              <div class="col-sm chart-controls">
                  <button type="button" class="btn btn-outline-secondary" onclick="updateChartType('candlestick')">Candles</button>
                  <button type="button" class="btn btn-outline-secondary" onclick="updateChartType('bar')">Bar</button>
                  <button type="button" class="btn btn-outline-secondary" onclick="updateChartType('line')">Line</button>
              </div>
          </div>
        </div>

        <div id="chart_div"></div>

    </div>
    <div id="technical_panel" class="container-fluid py-4" style="display: none;">
    technical_panel
    </div>
    <div id="fundamental_panel" class="container-fluid py-4" style="display: none;">
    fundamental_panel
    </div>
    <div id="ratings_panel" class="container-fluid py-4" style="display: none;">
    ratings_panel
    </div>
    <div id="estimates_panel" class="container-fluid py-4" style="display: none;">
    estimates_panel
    </div>
    <div id="financials_panel" class="container-fluid py-4" style="display: none;">
    financials_panel
    </div>
    <div id="ownership_panel" class="container-fluid py-4" style="display: none;">
    ownership_panel
    </div>
    <div id="news_panel" class="container-fluid py-4" style="display: none;">
    news_panel
    </div>

    <!------- Transaction -------->
    <!-- Buy Transaction -->
    <div class="modal fade" id="buyTransactionModal" tabindex="-1" aria-labelledby="buyTransactionModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="buyTransactionModalLabel">Buy Transaction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="buyTransactionForm">
                        <div class="mb-3">
                            <label for="buy_quantity_final" class="form-label">Final Quantity</label>
                            <input type="number" class="form-control" id="buy_quantity_final" required>
                        </div>
                        <div class="mb-3">
                            <label for="buy_price_final" class="form-label">Final Price</label>
                            <input type="number" class="form-control" id="buy_price_final" required>
                        </div>
                        <div class="mb-3">
                            <label for="buy_date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="buy_date" required>
                        </div>
                        <input type="hidden" id="buy_order_Id">
                        <input type="hidden" id="buy_trade_Id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addBuyTransaction()">Submit</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Sell Transaction-->
    <div class="modal fade" id="sellTransactionModal" tabindex="-1" aria-labelledby="sellTransactionModalLabel"
         aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="sellTransactionModalLabel">Sell Transaction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="sellTransactionForm">
                        <div class="mb-3">
                            <label for="sell_quantity_final" class="form-label">Final Quantity</label>
                            <input type="number" class="form-control" id="sell_quantity_final" required>
                        </div>
                        <div class="mb-3">
                            <label for="sell_price_final" class="form-label">Final Price</label>
                            <input type="number" class="form-control" id="sell_price_final" required>
                        </div>
                        <div class="mb-3">
                            <label for="sell_date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="sell_date" required>
                        </div>
                        <div class="mb-3">
                            <label for="sell_commission" class="form-label">Commission</label>
                            <input type="number" class="form-control" id="sell_commission" required>
                        </div>
                        <input type="hidden" id="sell_order_id">
                        <input type="hidden" id="sell_trade_Id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="addSellTransaction()">Submit</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Transaction Modal -->
    <div class="modal fade" id="editTransactionModal" tabindex="-1" aria-labelledby="editTransactionLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editTransactionLabel">Edit Transaction</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editTransactionForm">
                        <div class="mb-3">
                            <label for="edit_quantity_final" class="form-label">Final Quantity</label>
                            <input type="number" class="form-control" id="edit_quantity_final" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_price_final" class="form-label">Final Price</label>
                            <input type="number" class="form-control" id="edit_price_final" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_date" class="form-label">Date</label>
                            <input type="date" class="form-control" id="edit_date" required>
                        </div>
                        <div class="mb-3">
                            <label for="edit_commission" class="form-label">Commission</label>
                            <input type="number" class="form-control" id="edit_commission" required>
                        </div>
                        <input type="hidden" id="edit_action_id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="updateTransaction()">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <!------- Order -------->
    <!-- Create Order Modal -->
    <div class="modal fade" id="createOrderModal" tabindex="-1" aria-labelledby="createOrderModalLabel"
         aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="createOrderModalLabel">----</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    <input type="hidden" id="id_order_style">
                    <input type="hidden" id="name_order_style">
                </div>
                <div class="modal-body">
                    <form id="createBuyOrderForm">
                        <div class="row mt-3">
                            <div class="col-3 col-sm-4">
                                <label>Action</label>
                                <select class="form-select" id="id_action" name="{{ form_order.action.name }}"
                                        onchange="toggleCreateOrderAction(document.getElementById('name_order_style').value)">
                                    {% for choice in form_order.action.field.choices %}
                                        {% if choice.0 == '0' or choice.0 == '1'  or choice.0 == '2' %}
                                            <option value="{{ choice.0 }}" {% if choice.0 == '1' %}selected{% endif %}>
                                                {{ choice.1 }}
                                            </option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12 col-sm-4" id="lab_trade">
                                <label for="title_sell_trade">Trade ID</label>
                                <select class="form-select" id="id_trade">
                                    {% for trade in trade_ids %}
                                        <option value="{{ trade.trade_id }}">{{ trade.trade_id }}</option>
                                    {% endfor %}
                                    <option value="">--------------</option>
                                </select>
                            </div>
                            <div class="col-3 col-sm-4" id="lab_ref_order">
                                <label for="id_ref_order">Reference Order</label>
                                <select class="form-select" id="id_ref_order">
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-3 col-sm-4 mt-3 mt-sm-0">
                                <label>Quantity target</label>
                                {{ form_order.quantity_target }}
                            </div>
                            <div class="col-3 col-sm-4 mt-3 mt-sm-0">
                                <label for="{{ form_order.order_place_date.id_for_label }}">Order Place Date</label>
                                {{ form_order.order_place_date }}
                            </div>
                            <div class="col-12 col-sm-4 mt-3 mt-sm-0">
                                <label>Timing</label>
                                <select class="form-select" id="id_timing" name="{{ form_order.timing.name }}">
                                    {% for choice in form_order.timing.field.choices %}
                                        <option value="{{ choice.0 }}" {% if choice.0 == '2' %}selected{% endif %}>
                                            {{ choice.1 }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-3 col-sm-4 mt-3 mt-sm-0">
                                <label for="{{ form_order.order_type.id_for_label }}">Order Type</label>
                                <select class="form-select" id="id_order_type"
                                        name="{{ form_order.order_type.name }}" onchange="toggleCreateOrderPrice()">
                                    {% for choice in form_order.order_type.field.choices %}
                                        <option value="{{ choice.0 }}" {% if choice.0 == '1' %}selected{% endif %}>
                                            {{ choice.1 }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-3 col-sm-4 mt-3 mt-sm-0" id="lab_price_market">
                                <label>Market Price</label>
                                {{ form_order.price_market }}
                            </div>
                            <div class="col-3 col-sm-4 mt-3 mt-sm-0" id="lab_price_stop">
                                <label>Stop Price</label>
                                {{ form_order.price_stop }}
                            </div>
                            <div class="col-3 col-sm-4 mt-3 mt-sm-0" id="lab_price_limit">
                                <label>Limit Price</label>
                                {{ form_order.price_limit }}
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitCreateOrder()">Submit</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Order Modal -->
    <div class="modal fade" id="editOrderModal" tabindex="-1" aria-labelledby="editOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editOrderModalLabel">Edit xxx Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    <input type="hidden" id="edit_id_order_style">
                    <input type="hidden" id="edit_name_order_style">
                </div>
                <div class="modal-body">
                    <form id="editTransactionForm">
                        <div class="row mt-3">
                            <div class="col-3 col-sm-4">
                                <label>Action</label>
                                <select class="form-select" id="edit_action" name="{{ form_order.action.name }}"
                                        onchange="toggleEditOrderAction(document.getElementById('edit_name_order_style').value)">
                                    {% for choice in form_order.action.field.choices %}
                                            <option value="{{ choice.0 }}">
                                                {{ choice.1 }}
                                            </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-12 col-sm-4" id="lab_edit_trade">
                                <label for="edit_trade">Trade ID</label>
                                <select class="form-select" id="edit_trade">
                                    {% for trade in trade_ids %}
                                        <option value="{{ trade.trade_id }}">{{ trade.trade_id }}</option>
                                    {% endfor %}
                                    <option value="">--------------</option>
                                </select>
                            </div>
                            <div class="col-3 col-sm-4" id="lab_ref_edit_order">
                                <label for="ref_edit_order">Reference Order</label>
                                <select class="form-select" id="ref_edit_order">
                                </select>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-3 mb-3">
                                <label for="edit_quantity_target" class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="edit_quantity_target" required>
                            </div>
                            <div class="col-3 mb-3">
                                <label for="edit_order_place_date">Order Place Date</label>
                                <input type="date" class="form-control" id="edit_order_place_date">
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-3 col-sm-4 mt-3 mt-sm-0">
                                <label for="{{ form_order.order_type.id_for_label }}">Order Type</label>
                                <select class="form-select" id="edit_order_type"  onchange="toggleEditOrderPrice()">
                                    {% for choice in form_order.order_type.field.choices %}
                                        <option value="{{ choice.0 }}">
                                            {{ choice.1 }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-3 mb-3" id="lab_edit_price_market">
                                <label for="edit_price_market" class="form-label">Market</label>
                                <input type="number" class="form-control" id="edit_price_market" step="0.01">
                            </div>
                            <div class="col-3 mb-3" id="lab_edit_price_stop">
                                <label for="edit_price_stop" class="form-label">Stop</label>
                                <input type="number" class="form-control" id="edit_price_stop" step="0.01">
                            </div>
                            <div class="col-3 mb-3" id="lab_edit_price_limit">
                                <label for="edit_price_limit" class="form-label">Limit</label>
                                <input type="number" class="form-control" id="edit_price_limit" step="0.01">
                            </div>
                        </div>
                        <input type="hidden" id="edit_order_id">
                        <hr style="border: 1px solid black;">
                        <div class="row mt-3">
                            <div class="col-12">
                                <label><h6>Reference additional Orders</h6></label>
                                <ul id="ref_order_list" class="list-group">
                                    <!-- Reference orders will be populated here -->
                                </ul>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitEditOrder()">Save changes</button>
                </div>
            </div>
        </div>
    </div>
    <!-- Adjust Order Modal -->
    <div class="modal fade" id="adjustSellOrderModal" tabindex="-1" aria-labelledby="adjustSellOrderModalLabel" aria-hidden="true">
        <div class="modal-dialog  modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adjustSellOrderModalLabel">Adjust Sell Order</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="adjustSellOrderForm">
                        <div class="row mt-3">
                            <div class="col-3 mb-3">
                                <label for="adjust_sell_quantity" class="form-label">Quantity</label>
                                <input type="number" class="form-control" id="adjust_sell_quantity" required>
                            </div>
                            <div class="col-3 mb-3">
                                <label for="adjust_sell_price_stop" class="form-label">Stop</label>
                                <input type="number" class="form-control" id="adjust_sell_price_stop" step="0.01">
                            </div>
                            <div class="col-3 mb-3">
                                <label for="adjust_sell_price_limit" class="form-label">Limit</label>
                                <input type="number" class="form-control" id="adjust_sell_price_limit" step="0.01">
                            </div>
                            <div class="col-3 mb-3">
                                <label for="adjust_order_place_date" class="form-label">Order Place Date</label>
                                <input type="date" class="form-control" id="adjust_order_place_date" required>
                            </div>
                        </div>
                        <input type="hidden" id="adjust_sell_order_id">
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="submitAdjustSellOrder()">Save changes</button>
                </div>
            </div>
        </div>
    </div>


{% include 'includes/footer.html' %}
<script src="{% static 'assets/js/plugins/datatables.js' %}"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>

    ////////////////////////////////////////////// Holding html //////////////////////////////////////////////
    if (document.getElementById('buy_order_table')) {
      new simpleDatatables.DataTable("#buy_order_table", {
        searchable: true,
        fixedHeight: false,
        perPage: 7
      });
    }
    if (document.getElementById('buy_action_table')) {
      new simpleDatatables.DataTable("#buy_action_table", {
        searchable: true,
        fixedHeight: false,
        perPage: 7
      });
    }
    if (document.getElementById('sell_order_table')) {
      new simpleDatatables.DataTable("#sell_order_table", {
        searchable: true,
        fixedHeight: false,
        perPage: 7
      });
    }
    if (document.getElementById('sell_action_table')) {
      new simpleDatatables.DataTable("#sell_action_table", {
        searchable: true,
        fixedHeight: false,
        perPage: 7
      });
    }

    ////////////////////////////////////////////// Transaction js //////////////////////////////////////////////
    function showBuyOrderFill(order_Id, trade_id, price_market, order_place_date, quantity_target) {
        // Set the order ID in the hidden input field
        document.getElementById('buy_order_Id').value = order_Id;
        document.getElementById('buy_trade_Id').value = trade_id;
        // Set the values in the modal input fields
        document.getElementById('buy_date').value = new Date().toISOString().split('T')[0]; //order_place_date;
        document.getElementById('buy_quantity_final').value = quantity_target;
        document.getElementById('buy_price_final').value = price_market;
        // Show the modal
        new bootstrap.Modal(document.getElementById('buyTransactionModal')).show();
    }
    function showSellOrderFill(order_id, trade_Id, price_limit, order_place_date, quantity_target) {
        // Set the order ID in the hidden input field
        document.getElementById('sell_order_id').value = order_id;
        document.getElementById('sell_trade_Id').value = trade_Id;
        // Set the values in the modal input fields
        document.getElementById('sell_price_final').value = price_limit;
        document.getElementById('sell_date').value = new Date().toISOString().split('T')[0]; //order_place_date;
        document.getElementById('sell_quantity_final').value = quantity_target;
        // Show the modal
        new bootstrap.Modal(document.getElementById('sellTransactionModal')).show();
    }

    async function addBuyTransaction() {
        const buy_order_Id = document.getElementById('buy_order_Id').value;
        const buy_trade_Id = document.getElementById('buy_trade_Id').value;
        const quantityFinal = document.getElementById('buy_quantity_final').value;
        const priceFinal = document.getElementById('buy_price_final').value;
        const date = document.getElementById('buy_date').value;
        addTransaction('Buy', buy_order_Id, buy_trade_Id, quantityFinal, priceFinal, date, null);
    }
    async function addSellTransaction() {
        const sell_order_Id = document.getElementById('sell_order_id').value;
        const sell_trade_Id = document.getElementById('sell_trade_Id').value;
        const quantityFinal = document.getElementById('sell_quantity_final').value;
        const priceFinal = document.getElementById('sell_price_final').value;
        const date = document.getElementById('sell_date').value;
        const commission = document.getElementById('sell_commission').value;
        addTransaction('Sell', sell_order_Id, sell_trade_Id, quantityFinal, priceFinal, date, commission);
    }

    async function addTransaction(type, order_Id, trade_id, quantityFinal, priceFinal, date, commission) {
        const response = await fetch('/transaction/add/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                holding_id: {{ holding.holding_id }},
                trade_id : trade_id,
                quantity_final: quantityFinal,
                price_final: priceFinal,
                date: date,
                commission: commission,
                reference : {
                    type: type,
                    ref_id: order_Id
                }
            })
        });

        if (response.ok) {
            showNotification('success', 'Transaction', 'Order executed successfully!', new Date().toLocaleTimeString());
            setTimeout(function() {location.reload();}, 1000);
        } else {
            showNotification('error', 'Transaction', 'Failed to execute order.', new Date().toLocaleTimeString());
        }
    }
    function editTransaction(id) {
        fetch(`/transaction/${id}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('edit_action_id').value = data.id;
                document.getElementById('edit_quantity_final').value = data.quantity_final;
                document.getElementById('edit_price_final').value = data.price_final;
                document.getElementById('edit_date').value = data.date;
                document.getElementById('edit_commission').value = data.commission;
                new bootstrap.Modal(document.getElementById('editTransactionModal')).show();
            })
            .catch(error => console.error('Error fetching buy action data:', error));
    }
    async function updateTransaction() {
        const id = document.getElementById('edit_action_id').value;
        const quantity_final = document.getElementById('edit_quantity_final').value;
        const price_final = document.getElementById('edit_price_final').value;
        const date = document.getElementById('edit_date').value;
        const commission = document.getElementById('edit_commission').value;

        const response = await fetch(`/transaction/${id}/update/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                quantity_final: quantity_final,
                price_final: price_final,
                date: date,
                commission: commission
            })
        });

        if (response.ok) {
            showNotification('success', 'Transaction', 'Action updated successfully!', new Date().toLocaleTimeString());
            setTimeout(function() {location.reload();}, 1000);
        } else {
            showNotification('error', 'Transaction', 'Failed to update action.', new Date().toLocaleTimeString());
        }
    }
    async function deleteTransaction(id) {
        if (confirm("Are you sure you want to delete this transaction?")) {
            const response = await fetch(`/transaction/${id}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            if (response.ok) {
                showNotification('success', 'Transaction', 'Transaction deleted successfully!', new Date().toLocaleTimeString());
                setTimeout(function() {location.reload();}, 1000);
            } else {
                showNotification('error', 'Transaction', 'Failed to delete Transaction.', new Date().toLocaleTimeString());
            }
        }
    }

   ////////////////////////////////////////////// Order js //////////////////////////////////////////////

    // toggle
    function toggleCreateOrderAction(order_style){ toggleOrderAction(order_style, 'id_action', 'lab_trade', 'lab_ref_order');}
    function toggleEditOrderAction(order_style){ toggleOrderAction(order_style, 'edit_action', 'lab_edit_trade', 'lab_ref_edit_order'); }

    function toggleCreateOrderPrice(){ toggleOrderPrice('id_order_type', 'lab_price_market', 'lab_price_stop', 'lab_price_limit'); }
    function toggleEditOrderPrice(){ toggleOrderPrice('edit_order_type', 'lab_edit_price_market', 'lab_edit_price_stop', 'lab_edit_price_limit');}

    function toggleOrderModal(id_modal, id_order_style, name_order_style, order_style){
        const modal = document.getElementById(id_modal);
        const style_id = document.getElementById(id_order_style);
        const style_name = document.getElementById(name_order_style);

        style_name.value = order_style
        if (order_style === 'buy') {
            modal.textContent = 'Create Buy Order';
            style_id.value = 1;
        } else if (order_style === 'sell') {
            modal.textContent = 'Create Sell Order';
            style_id.value = 2;
        }else {
            modal.textContent = 'UnKnown Order';
            style_id.value = 0;
        }
    }
    function toggleOrderAction(order_style, id_action, lab_trade, lab_ref_order){
        const action = document.getElementById(id_action).value;
        const ref_trade = document.getElementById(lab_trade);
        const ref_order = document.getElementById(lab_ref_order);

        if (action === '1' || action === '0' ){
            ref_trade.style.display= order_style === 'buy' ? 'none' : 'block';
            ref_order.style.display = 'none';
        } else {
            ref_trade.style.display = 'none';
            ref_order.style.display = 'block';
        }
    }
    function toggleOrderPrice(id_order_type, id_price_market, id_price_stop, id_price_limit) {
        const order_type = document.getElementById(id_order_type).value;
        const market_price = document.getElementById(id_price_market);
        const stop_price = document.getElementById(id_price_stop);
        const limit_price = document.getElementById(id_price_limit);

        market_price.style.display = 'none';
        stop_price.style.display = 'none';
        limit_price.style.display = 'none';

        if (order_type === '1') { // Market
            market_price.style.display = 'block';
        } else if (order_type === '3') { // Stop
            stop_price.style.display = 'block';
        } else if (order_type === '2') { // Limit
            limit_price.style.display = 'block';
        } else if (order_type === '4') { // Stop Limit
            stop_price.style.display = 'block';
            limit_price.style.display = 'block';
        }
    }

    // load
    function loadEditOrder(id) {
        // Fetch the existing data and populate the modal fields
        fetch(`/position/order/${id}/`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('edit_order_id').value = data.id;

                document.getElementById('edit_action').value = data.action;

                document.getElementById('edit_order_type').value = data.order_type;
                document.getElementById('edit_quantity_target').value = data.quantity_target;
                document.getElementById('edit_price_market').value = data.price_market;
                document.getElementById('edit_price_stop').value = data.price_stop;
                document.getElementById('edit_price_limit').value = data.price_limit;

                document.getElementById('edit_order_place_date').value = data.order_place_date;

                //Reference Orders
                fetchRefOrders(data.id); // Fetch and display reference orders

                //modal
                EditOrderModal(data.order_style === '1' ? 'buy' : 'sell');
            });
    }
    function CreateOrderModal(order_style, order_type) {
        //modal
        toggleOrderModal('createOrderModalLabel', 'id_order_style', 'name_order_style', order_style);
        //Action
        toggleCreateOrderAction(order_style);
        //Price
        document.getElementById('id_order_type').value = order_type;
        toggleCreateOrderPrice();
        //load reference order
        reloadRefOrderOptions('id_ref_order', order_style);
        //Show modal
        new bootstrap.Modal(document.getElementById('createOrderModal')).show();
    }
    function EditOrderModal(order_style) {
        //modal
        toggleOrderModal('editOrderModalLabel', 'edit_id_order_style', 'edit_name_order_style', order_style);
        //Action
        toggleEditOrderAction(order_style);
        //Price
        toggleEditOrderPrice();
        //load reference order
        reloadRefOrderOptions('ref_edit_order', order_style);
        //Show modal
        new bootstrap.Modal(document.getElementById('editOrderModal')).show();
    }

    // save
    async function submitCreateOrder() {
        const ref_order_id = document.getElementById('id_ref_order').value;
        const trade_id = document.getElementById('id_trade').value;

        const order_style = document.getElementById('id_order_style').value;
        const order_type = document.getElementById('id_order_type').value;
        const quantity_target = document.getElementById('id_quantity_target').value;
        const price_market = document.getElementById('id_price_market').value;
        const price_stop = document.getElementById('id_price_stop').value;
        const price_limit = document.getElementById('id_price_limit').value;

        const order_place_date = document.getElementById('id_order_place_date').value;

        const action = document.getElementById('id_action').value;
        const timing = document.getElementById('id_timing').value;

        const response = await fetch('/position/order/create/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                holding_id: {{ holding.holding_id }},
                ref_order_id: ref_order_id,
                trade_id: trade_id,

                order_style: order_style,
                order_type: order_type,
                quantity_target: quantity_target,
                price_market: price_market,
                price_stop: price_stop,
                price_limit: price_limit,

                order_place_date: order_place_date,

                action: action,
                timing: timing,
            })
        });

        if (response.ok) {
            if (order_style === '1') {
                showNotification('success', 'Order', 'Buy Order created successfully!', new Date().toLocaleTimeString());
            } else if (order_style === '2') {
                showNotification('error', 'Order', 'Sell Order created successfully!', new Date().toLocaleTimeString());
            }
            setTimeout(function() {location.reload();}, 1000);
        } else {
                showNotification('error', 'Order', 'Failed to create Order.', new Date().toLocaleTimeString());
        }
    }
    async function submitEditOrder() {
        const id = document.getElementById('edit_order_id').value;

        const action = document.getElementById('edit_action').value;
        const trade_id = document.getElementById('edit_trade').value;
        const ref_order_id = document.getElementById('ref_edit_order').value;

        const order_type = document.getElementById('edit_order_type').value;
        const quantity_target = document.getElementById('edit_quantity_target').value;
        const price_market = document.getElementById('edit_price_market').value;
        const price_stop = document.getElementById('edit_price_stop').value;
        const price_limit = document.getElementById('edit_price_limit').value;

        const order_place_date = document.getElementById('edit_order_place_date').value;

        const response = await fetch(`/position/order/${id}/edit/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                action: action,
                trade_id: trade_id,
                ref_order_id: ref_order_id,

                order_type: order_type,
                quantity_target: quantity_target,
                price_market: price_market,
                price_stop: price_stop,
                price_limit: price_limit,

                order_place_date:  order_place_date
            })
        });

        if (response.ok) {
            showNotification('success', 'Order', 'Order updated successfully!', new Date().toLocaleTimeString());
            setTimeout(function() { location.reload(); }, 1000);
        } else {
            showNotification('error', 'Order', 'Failed to update order.', new Date().toLocaleTimeString());
        }
    }

    // fetch reference orders
    async function fetchRefOrders(ref_order_id) {
        const response = await fetch(`/position/order/${ref_order_id}/ref/`);
        const refOrders = await response.json();
        const refOrderList = document.getElementById('ref_order_list');
        refOrderList.innerHTML = '';

        refOrders.forEach(order => {
            const listItem = document.createElement('li');
            listItem.className = 'list-group-item';
            listItem.textContent = `Order ID: ${order.id}, BUY ${order.quantity_target} @ Price: ${order.price}`;
            refOrderList.appendChild(listItem);
        });
    }

    // adjust stop limit order
    function popAdjustSellOrder(order_id, quantity_target, price_stop, price_limit) {
        // Set the order ID in the hidden input field
        document.getElementById('adjust_sell_order_id').value = order_id;
        // Set the values in the modal input fields
        document.getElementById('adjust_sell_quantity').value = quantity_target;
        document.getElementById('adjust_sell_price_stop').value = price_stop;
        document.getElementById('adjust_sell_price_limit').value = price_limit;
        {#console.log("order_place_date->"+order_place_date);#}
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('adjust_order_place_date').value = today;
        // Show the modal
        new bootstrap.Modal(document.getElementById('adjustSellOrderModal')).show();
    }
    async function submitAdjustSellOrder() {
        const order_id = document.getElementById('adjust_sell_order_id').value;

        const quantity_target = document.getElementById('adjust_sell_quantity').value;
        const price_stop = document.getElementById('adjust_sell_price_stop').value;
        const price_limit = document.getElementById('adjust_sell_price_limit').value;
        const order_place_date = document.getElementById('adjust_order_place_date').value;

        const response = await fetch(`/position/order/${order_id}/adjust/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                quantity_target: quantity_target,
                price_stop: price_stop,
                price_limit: price_limit,
                order_place_date: order_place_date,
            })
        });

        if (response.ok) {
            showNotification('success', 'Order', 'Order adjust successfully!', new Date().toLocaleTimeString());
            setTimeout(function() {location.reload();}, 1000);
        } else {
            showNotification('error', 'Order', 'Failed to adjust order.', new Date().toLocaleTimeString());
        }
    }

    async function deleteOrder(id) {
        if (confirm("Are you sure you want to delete this order?")) {
            const response = await fetch(`/position/order/${id}/delete/`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}'
                }
            });

            if (response.ok) {
                showNotification('success', 'Order', 'Order deleted successfully!', new Date().toLocaleTimeString());
                setTimeout(function() {location.reload();}, 1000);
            } else {
                showNotification('error', 'Order', 'Failed to delete order.', new Date().toLocaleTimeString());
            }
        }
    }

    async function calculateTrade(tradeId) {
        const response = await fetch(`/position/trade/${tradeId}/calculate/`, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        });

        if (response.ok) {
            const data = await response.json();
            showNotification('success', 'Trade', `Trade calculation completed. Is Finished: ${data.is_finished}`, new Date().toLocaleTimeString());
        } else {
            showNotification('error', 'Trade', 'Failed to calculate trade.', new Date().toLocaleTimeString());
        }
    }

    async function reloadRefOrderOptions(id_ref_order, order_style) {
        const refOrderSelect = document.getElementById(id_ref_order);
        const buyOrders = [
            {% for order in buy_orders %}
            { id: '{{ order.order_id }}', text: '[{{ order.order_id }}]: Buy {{ segment|order_name:order }}' },
            {% endfor %}
        ];
        const sellOrders = [
            {% for order in sell_orders %}
            { id: '{{ order.order_id }}', text: '[{{ order.order_id }}]: Sell {{ segment|order_name:order }}' },
            {% endfor %}
        ];

        // Clear existing options
        refOrderSelect.innerHTML = '';

        // Add filtered options
        let orders = [];
        if (order_style === 'buy') {
            orders = buyOrders;
        } else if (order_style === 'sell') {
            orders = sellOrders;
        }

        orders.forEach(order => {
            const option = document.createElement('option');
            option.value = order.id;
            option.textContent = order.text;
            refOrderSelect.appendChild(option);
        });

        // Add default option
        const defaultOption = document.createElement('option');
        defaultOption.value = '';
        defaultOption.textContent = '--------------------';
        refOrderSelect.appendChild(defaultOption);
    }

    ////////////////////////////////////////////// Quote html //////////////////////////////////////////////
    const panels = [
        'holding', 'profile', 'chart', 'technical', 'fundamental',
        'ratings', 'estimates', 'financials', 'ownership', 'news'
    ];// Hide all panels

    panels.forEach(panel => {
        document.getElementById(panel + "_btn").addEventListener('click', function() {
            showPanel(panel);
        });
    });

    function showPanel(panelId) {
        panels.forEach(panel => {
            document.getElementById(panel + "_panel").style.display = 'none';
            document.getElementById(panel + "_btn").classList.remove('active');
        });
        // Show the selected panel
        const selectedPanel = document.getElementById(panelId + "_panel");
        if (selectedPanel) {
            selectedPanel.style.display = 'block';
            document.getElementById(panelId + "_btn").classList.add('active');
           if ("chart" === panelId) {
                renderChart('{{ symbol }}', currentChartType, currentInterval);
            }
        }
    }

    ////////////////////////////////////////////// Chart Panel //////////////////////////////////////////////
    let currentChartType = 'candlestick'; // Default chart type
    let currentInterval = 'daily'; // Default interval

    // Function to update button classes
    function updateButtonClasses() {
        const intervals = ['daily', 'weekly', 'monthly'];
        const chartTypes = ['candlestick', 'bar', 'line'];

        intervals.forEach(interval => {
            const button = document.querySelector(`button[onclick="updateChartInterval('${interval}')"]`);
            if (interval === currentInterval) {
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-outline-info');
            } else {
                button.classList.remove('btn-outline-info');
                button.classList.add('btn-outline-secondary');
            }
        });

        chartTypes.forEach(type => {
            const button = document.querySelector(`button[onclick="updateChartType('${type}')"]`);
            if (type === currentChartType) {
                button.classList.remove('btn-outline-secondary');
                button.classList.add('btn-outline-info');
            } else {
                button.classList.remove('btn-outline-info');
                button.classList.add('btn-outline-secondary');
            }
        });
    }

    // Function to update chart type
    function updateChartType(type) {
        currentChartType = type;
        updateButtonClasses();
        renderChart('{{ symbol }}', currentChartType, currentInterval);
    }
    // Function to update chart interval
    function updateChartInterval(interval) {
        currentInterval = interval;
        updateButtonClasses();
        renderChart('{{ symbol }}', currentChartType, currentInterval);
    }

    // Fetch stock data and render Plotly chart
    async function fetchStockData(symbol, interval) {
        const response = await fetch(`/screening/api/stock_data?symbol=${symbol}&interval=${interval}`);
        return await response.json();
    }

    async function renderChart(symbol, chartType = 'candlestick', interval = 'daily') {
        const stockData = await fetchStockData(symbol, interval);
        let trace, volumeTrace, sma50Trace, sma200Trace;

        if (chartType === 'candlestick') {
            trace = {
                x: stockData.time,
                close: stockData.close,
                decreasing: {line: {color: 'red'}},
                high: stockData.high,
                increasing: {line: {color: 'green'}},
                low: stockData.low,
                open: stockData.open,
                type: 'candlestick',
                name: 'Price'
            };
        } else if (chartType === 'line') {
            trace = {
                x: stockData.time,
                y: stockData.close,
                type: 'scatter',
                mode: 'lines',
                name: 'Price'
            };
        } else {
            //heikin-ashi
            trace = {
                x: stockData.time,
                close: stockData.close,
                decreasing: {line: {color: 'red'}},
                high: stockData.high,
                increasing: {line: {color: 'green'}},
                low: stockData.low,
                open: stockData.open,
                type: 'ohlc',
                name: 'Price'
            };
        }

        // Add SMA lines
        sma50Trace = {
            x: stockData.time,
            y: stockData.SMA_50,
            type: 'scatter',
            mode: 'lines',
            name: 'SMA 50',
            line: {color: 'blue'}
        };

        sma200Trace = {
            x: stockData.time,
            y: stockData.SMA_200,
            type: 'scatter',
            mode: 'lines',
            name: 'SMA 200',
            line: {color: 'orange'}
        };

        // Add volume trace with conditional coloring
        const volumeColors = stockData.close.map(
            (close, index) => close > stockData.open[index] ? 'gray' : 'red');

        volumeTrace = {
            x: stockData.time,
            y: stockData.volume,
            type: 'bar',
            name: 'Volume',
            yaxis: 'y2',
            marker: {color: volumeColors}
        };
        console.log(volumeTrace)

        const layout = {
            title: `Stock Prices for ${symbol} (${interval})`,
            xaxis: {
                title: 'Date',
                rangeslider: {
                    visible: true,
                    thickness: 0.015, // Adjust the thickness to make the rangeslider smaller
                    bgcolor: 'gray'
                }
            },
            yaxis: {
                title: 'Price',
                domain: [0.2, 1 ] // Use 80% of the top part of the chart
            },
            yaxis2: {
                title: 'Volume',
                domain: [0, 0.2], // Use only 20% of the entire chart height
                showgrid: false,
                zeroline: false,
            },
            height: 800, // Adjust the height of the chart
        };

        Plotly.newPlot('chart_div', [trace, sma50Trace, sma200Trace,volumeTrace], layout);
        adjustChartWidth();
    }

    // Function to adjust chart width
    function adjustChartWidth() {
        const chartPanel = document.getElementById('chart_panel');
        const chartDiv = document.getElementById('chart_div');
        const pageWidth = chartPanel.clientWidth;
        chartDiv.style.width = `${pageWidth}px`;

        // Re-render the Plotly chart with the new width
        Plotly.relayout(chartDiv, {
            width: pageWidth
        });
    }
    // Add event listener to window resize event
    window.addEventListener('resize', adjustChartWidth);

    ////////////////////////////////////////////// init Setup Chart Panel //////////////////////////////////////////////
    // Initial adjustment
    updateButtonClasses();
    {#showPanel("profile");#}
    showPanel("holding");

</script>
{% endblock content %}

  